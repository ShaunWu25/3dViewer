<!DOCTYPE html>
<html lang="en">
<head>
    <title>xeogl Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <script src="js/xeogl.js"></script>
    <script src="js/app.js">  </script>
    <script src="js/glTFModel.js"></script>
    <script src="js/dat.gui.min.js"></script>
    <script src="js/skybox.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>

    <link href="css/styles.css" rel="stylesheet"/>

<body>
<!--
<div id="info">
    <h1><a href="../docs/classes/GLTFModel.html" target="_parent">GLTFModel</a> - importing Schependomlaan IFC model from glTF</h1>
    <br>
    <ul>
        <li>IFC model from <a href='https://github.com/openBIMstandards/DataSetSchependomlaan' target="_parent">github.com/openBIMstandards</a></li>
        <li>IFC converted to COLLADA using <a href='http://ifcopenshell.org/ifcconvert.html' target="_parent">IfcConvert</a></li>
        <li>COLLADA converted to glTF using <a href='https://github.com/KhronosGroup/COLLADA2GLTF' target="_parent">COLLADA2GLTF</a></li>
        <li>viewed in xeogl using a <a href='../docs/classes/GLTFModel.html' target="_parent">GLTFModel</a> component</li>
    </ul>
</div>
-->
<form class = "desk">
    GUID:  <input id="myInput" type="text" name="guid">   <button id = "myButton" type='button'> Submit </button>
    

</form>
<div id="dat-gui-container">
</div>

<script>

    function showName() {                
        var myName = $("#myInput").val();                
        console.log(myName);

        return myName;
    }
    var inputGuid;
    $("#myButton").click(function () {
        inputGuid = showName();
        var myTest = guidArray.includes(inputGuid);
        console.log("Is this GUID in the current model? " + myTest);

        if(myTest){
            cameraFlight.flyTo(model.meshes[inputGuid]);
            model.highlighted = false;
            model.meshes[inputGuid].highlighted = true;
        }
    });

    

    var guidArray = [];
    /*
    var model = new xeogl.GLTFModel({
        id:"test",
        src: "models/Hospital_FireAlarm.gltf",
        scale: [1, 1, 1],
        objectTree: true,
        handleNode: (function() {
            var objectCount = 0;
            return function (nodeInfo, actions) {
                if (nodeInfo.mesh !== undefined) { // Node has a mesh
                    var myName = nodeInfo.name;
                    guidArray.push(myName);
                    actions.createObject = {
                        id: myName,
                        guid: myName
                    };
                }
                return true;
            };
        })()
    });
    */
    
    
    var structure = new xeogl.GLTFModel({
        id: "structure",
        loaded: true,
        src: "models/Hospital_Structural.gltf",
        lambertMaterials: true,
        edgeThreshold: 3,
        ghosted: true
    });
    var sprinklers = new xeogl.GLTFModel({
        id: "sprinklers",
        loaded: false,
        src: "models/Hospital_Sprinkle.gltf",
        lambertMaterials: true,
        ghosted: false,
        selected: false,
        highlighted: false
    });
    var fireAlarms = new xeogl.GLTFModel({
        id: "fireAlarms",
        loaded: false,
        src: "models/Hospital_FireAlarm.gltf",
        lambertMaterials: true,
        ghosted: false,
        selected: false,
        highlighted: false
    });
    var electrical = new xeogl.GLTFModel({
        id: "electrical",
        loaded: false,
        src: "models/Hospital_Electrical.gltf",
        lambertMaterials: true,
        ghosted: false,
        highlighted: false
    });

    var scene = structure.scene;
    var camera = scene.camera;
    var input = scene.input;
    scene.ghostMaterial.preset = "defaultDarkBG";
    scene.ghostMaterial.edges = false;
    scene.ghostMaterial.edgeAlpha = 0.3;
    scene.ghostMaterial.fillAlpha = 0.3;

    camera.eye = [133.72, 235.56, -174.37];
    camera.look = [8.71, 142.89, -73.77];
    camera.up = [-0.38, 0.86, 0.30];
    var cameraControl = new xeogl.CameraControl({
        //panToPointer: true,
        //pivoting: true
    });

    var cameraFlight = new xeogl.CameraFlightAnimation();
    cameraControl.on("hoverEnter", function (hit) {
        hit.mesh.highlighted = true;
    });
    
    cameraControl.on("hoverOut", function (hit) {
        hit.mesh.highlighted = false;
    
    });
    
    cameraControl.on("picked", function (hit) {
        var mesh = hit.mesh;
        if (input.keyDown[input.KEY_SHIFT]) {
            mesh.selected = !mesh.selected;
            mesh.highlighted = !mesh.selected;
        } else {
            cameraFlight.flyTo(mesh);
        }
        console.log(mesh.guid);
    });

    
    cameraControl.on("pickedNothing", function (hit) {
        cameraFlight.flyTo(structure);
    });

    var culling = false;
    var timeout;
    var culled = false;

    camera.on("viewMatrix", function () {
        if (!culling) {
            return;
        }
        if (!culled) {
            sprinklers.culled = true;
            electrical.culled = true;
            plumbing.culled = true;
            fireAlarms.culled = true;
            culled = true;
        }
        if (timeout) {
            clearTimeout(timeout);
            timeout = null;
        }
        timeout = setTimeout(function () {
            sprinklers.culled = false;
            electrical.culled = false;
            plumbing.culled = false;
            fireAlarms.culled = false;
            culled = false;
            timeout = null;
        }, 100);
    });
    
    var gui = new dat.GUI({autoPlace: false, top: 0, right: 10, width: 350});
    document.getElementById('dat-gui-container').appendChild(gui.domElement);
    var modelIds = Object.keys(scene.models);
    var Menu = function () {
        this.message = "Models";
        for (var i = 0; i < modelIds.length; i++) {
            var modelId = modelIds[i];
            var model = scene.models[modelId];
            this[modelId + ".id"] = model.id;
            this[modelId + ".loaded"] = model.loaded;
            this[modelId + ".visible"] = model.visible;
            this[modelId + ".ghosted"] = model.ghosted;
            this[modelId + ".selected"] = model.selected;
            this[modelId + ".highlighted"] = model.highlighted;
        }
        var self = this;
        var update = function () {
            for (var i = 0; i < modelIds.length; i++) {
                var modelId = modelIds[i];
                var model = scene.models[modelId];
                var loaded = self[modelId + ".loaded"];
                if (model.loaded !== loaded) {
                    model.loaded = loaded;
                }
                var visible = self[modelId + ".visible"];
                if (model.visible !== visible) {
                    model.visible = visible;
                }
                var ghosted = self[modelId + ".ghosted"];
                if (model.ghosted !== ghosted) {
                    model.ghosted = ghosted;
                }
                var selected = self[modelId + ".selected"];
                if (model.selected !== selected) {
                    model.selected = selected;
                }
                var highlighted = self[modelId + ".highlighted"];
                if (model.highlighted !== highlighted) {
                    model.highlighted = highlighted;
                }
            }
            requestAnimationFrame(update);
        };
        update();
    };
    var menu = new Menu();
    for (var i = 0; i < modelIds.length; i++) {
        var modelId = modelIds[i];
        var model = scene.models[modelId];
        var folder = gui.addFolder(modelId);
        folder.add(menu, modelId + ".loaded", model.loaded);
        folder.add(menu, modelId + ".visible", model.visible);
        folder.add(menu, modelId + ".ghosted", model.ghosted);
        folder.add(menu, modelId + ".selected", model.selected);
        folder.add(menu, modelId + ".highlighted", model.highlighted);
        folder.open();
    }

    var clips = scene.clips;
    clips.clips = [
    new xeogl.Clip({  // Clip plane on negative diagonal
        pos: [1.0, 1.0, 1.0].listen(),
        dir: [1.0, 1.0, 1.0],
        active: true
    }),
    /*
    new xeogl.Clip({ // Clip plane on positive diagonal
        pos: [-1.0, -1.0, -1.0],
        dir: [1.0, 1.0, 1.0],
        active: true
    }),
    */
    //...
    ];

</script>
</body>
</html>